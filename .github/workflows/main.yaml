name: Gen time

on:
  push:
    branches:
      - main
  pull_request:
    branches: 
      - '*'

jobs:
  heap_memory_usage:
    name: Heap memory usage
    runs-on: macos-latest
    steps:
    
    - name: Checkout the code
      uses: actions/checkout@v3

    - name: run tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        script: |
            adb kill-server
            adb start-server
            chmod +x gradlew
            ./gradlew installDebug
            # adb shell cmd package list packages
            sleep 3
            acom.example.githubactionssampleproject4/com.example.githubactionssampleproject4.MainActivity
            adb -s emulator-5554 logcat &

    - name: Print heap memory usage
      run: |
        memory_info="$(adb shell dumpsys meminfo com.example.githubactionssampleproject4)"
        printf "%15s %15s %15s %15s\n" "" "Heap Size" "Heap Alloc" "Heap Free"
        printf "%15s %15s %15s %15s\n" "" "---------" "----------" "---------"
        echo "$memory_info" | grep "Native Heap" | head -1 | awk '{printf "%15s %15d %15d %15d\n", "Native Heap", $8, $9, $10}'
        echo "$memory_info" | grep "Dalvik Heap" | head -1 | awk '{printf "%15s %15d %15d %15d\n", "Dalvik Heap", $8, $9, $10}'
        echo "$memory_info" | grep "TOTAL" | head -1 | awk '{printf "%15s %15d %15d %15d\n", "TOTAL", $7, $8, $9}'
